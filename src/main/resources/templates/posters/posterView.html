<!DOCTYPE html>
<html lang="en" xmlns:th="http://thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
<div class="content container">
    <table class="table">
        <tr>
            <th>제목</th>
            <td th:text="${poster.title}"></td>
        </tr>
        <tr>
            <th>작성자</th>
            <td th:text="${poster.writer}"></td>
        </tr>
        <tr>
            <th>작성일</th>
            <td th:text="${#temporals.format(poster.regdate, 'yyyy-MM-dd HH:mm')}"></td>
        </tr>
        <tr>
            <th>내용</th>
            <td th:text="${poster.content}"></td>
        </tr>
    </table>
    <div class=" d-flex justify-content-end">
        <div class="btn-group">
            <button class="btn btn-primary" type="button"
                    th:onclick="|location.href='@{/poster/edit(id=${poster.id})}'|">수정
            </button>
            <button class="btn btn-primary" type="button"
                    th:onclick="|location.href='@{/poster/delete(id=${poster.id})}'|">삭제
            </button>
            <button class="btn btn-primary" type="button" th:onclick="|location.href='@{/posters}'|">목록</button>
        </div>
    </div>

    <div class="border-top border-bottom py-3 my-3">
        <form action="/comment/write" method="post">
            <div class="d-flex">
                <input class="justify-content-start h-25 mx-2" placeholder="작성자" type="text" name="writer"> <br>
                <input type="hidden" name="pno" th:value="${poster.id}">
                <textarea class="justify-content-end w-100 mx-2" type="text" placeholder="내용" name="content"></textarea>
            </div>
            <div class="d-flex justify-content-end mt-2">
                <button class="btn btn-primary" type="submit">제출</button>
            </div>
        </form>
    </div>

    <div>
        <div>
            <ul id="comments">
            </ul>
        </div>
        <div>
            <ul style="list-style-type: none;" id="pagination">
            </ul>
        </div>
    </div>

    <div>
        <ul>
            <li th:each="comment : ${comments}">
                <span th:text="|${comment.writer} ${comment.content} ${#temporals.format(comment.regDate, 'yyyy.MM.dd HH:mm')}|"> </span>
                <form th:action="@{/comment/delete}" method="post">
                    <input type="hidden" name="id" th:value="${comment.id}">
                    <button type="submit">삭제</button>
                </form>
            </li>
        </ul>
    </div>
</div>

<script src="/js/bootstrap.min.js"></script>

<script>
    function loadComments(pno, page) {
        $.ajax({
            type: "GET",
            url: `/comments?pno=${pno}&page=${page}`,
            dataType: "json",
            success: function (comments) {
                let commentUl = $("#comments");
                commentUl.empty(); // 선택 요소 비우는 작업

                makePagination(pno, comments);

                comments.content.forEach(function (comment) {
                    commentUl.append(`<li> ${comment.writer} ${comment.content} ${comment.regDate}
                                        <form th:action="@{/comment/delete}" method="post">
                                           <input type="hidden" name="id" th:value="${comment.id}">
                                            <button type="submit">삭제</button>
                                        </form>
                                       </li>`);
                })
            },
            error: function () {
                alert("error");
            }
        })
    }

    function makePagination(pno, page) {

        let pagination = $("#pagination");
        pagination.empty();

        let cur = page.number; // 0부터 센다.
        let endPage = Math.ceil((cur + 1) / 10.0) * 10; // 1~10
        let startPage = endPage - 9; // 1~10
        if (endPage > page.totalPages - 1) // totalPage는 1부터 센다 그래서 1을 빼줌
            endPage = page.totalPages;

        if (cur > 0) // 이전 버튼
            pagination.append(`<li style="float: left"><a href="javascript:void(0)" onclick="loadComments(${pno}, ${cur - 1})">이전</a></li>`);

        for (let i = startPage; i <= endPage; i++) { // 페이지네이션
            pagination.append(`<li style="float: left; margin-left: 2px"><a href="javascript:void(0)" onclick="loadComments(${pno}, ${i - 1})">${i}</a></li>`);
        }

        if (cur + 1 < page.totalPages) // 다음 버튼
            pagination.append(`<li style="float: left; margin-left: 2px"><a href="javascript:void(0)" onclick="loadComments(${pno}, ${cur + 1})">다음</a></li>`);
    }

    $(document).ready(function () {
            let pno = [[${poster.id}]];
            loadComments(pno, 0);
            console.log(pno);
        }
    );
</script>
</body>
</html>